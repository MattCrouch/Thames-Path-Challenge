$(document).ready(function(){$("#map").length>0&&map()});var map=function(){function n(){google.maps.event.addDomListener(window,"load",function(){d=new google.maps.Map($("#map")[0],{center:k.start,zoom:14}),o(),e(),t(),s(),u(),p()})}function e(){k={start:{name:"Putney Bridge",lat:51.46678,lng:-.213112,info:"START - Putney Bridge",icon:y.flag},"half way":{name:"Hurst Park",lat:51.392211,lng:-.344472,info:"25km - Half Way<br/>Hurst Park",icon:y.pointsOfInterest},finish:{name:"Runnymede Pleasure Ground",lat:51.442137,lng:-.55082,info:"FINISH - Runnymede",icon:y.flag}}}function o(){y.pointsOfInterest={anchor:new google.maps.Point(15,15),url:w+"live/icons/poi.svg",scaledSize:new google.maps.Size(30,30)},y.flag={anchor:new google.maps.Point(15,15),url:w+"live/icons/poi.svg",scaledSize:new google.maps.Size(30,30)},y.twitter={anchor:new google.maps.Point(15,15),url:w+"live/icons/twitter.svg",scaledSize:new google.maps.Size(30,30)},y.instagram={anchor:new google.maps.Point(15,15),url:w+"live/icons/instagram.svg",scaledSize:new google.maps.Size(30,30)}}function t(){a(v.pointsOfInterest),$.each(k,function(n,e){var o=l(e.lat,e.lng,e.name,e.icon);v.pointsOfInterest.push(o),f(v.pointsOfInterest);var t=new google.maps.InfoWindow({content:e.info});google.maps.event.addListener(o,"click",function(){i(),t.open(d,o),P.push(t)})})}function a(n){$.each(n,function(n,e){e.setMap(null)}),n=[]}function i(){$.each(P,function(n,e){e.close()})}function s(){h=new google.maps.Polyline({clickable:!1,strokeColor:"#0F3670",strokeOpacity:1,strokeWeight:5}),h.setMap(d),$.each(I,function(n,e){g(e)})}function c(n){var e={lat:n.lat,lng:n.lng,timestamp:n.timestamp};I.push(e),g(e)}function l(n,e,o,t){"undefined"==typeof t&&(t=null);var a=new google.maps.Marker({position:new google.maps.LatLng(n,e),title:o,icon:t});return a.setMap(d),a}function r(n){var e=l(n.lat,n.lng,"this is a post from "+n.source,y[n.source]),o=new google.maps.InfoWindow({content:m(n)});google.maps.event.addListener(e,"click",function(){i(),o.open(d,e),P.push(o)})}function g(n){var e=h.getPath(),o=new google.maps.LatLng(n.lat,n.lng);e.push(o)}function u(){$.ajax({url:"fetchcoords.php",data:{since:S.waypoints},type:"GET",success:function(n){S.waypoints=n.sinceTimestamp,$.each(n.coordinates,function(n,e){c(e)}),z&&setTimeout(function(){u()},6e4)},error:function(){alert("Can't get the location at the moment :(")}})}function p(){$.ajax({url:"fetchsocial.php",data:{since:S.social},type:"GET",success:function(n){S.social=n.sinceTimestamp,$.each(n.posts,function(n,e){r(e)}),z&&setTimeout(function(){p()},3e5)},error:function(){alert("Can't get social feeds :(")}})}function f(n){for(var e=new google.maps.LatLngBounds,o=0;o<n.length;o++)e.extend(n[o].getPosition());d.fitBounds(e)}function m(n){return html="<div class='social "+n.source+"'><a href='"+n.url+"' target='_blank'><img src='"+n.image+"'/></a><p class='caption'>"+n.text+"</p></div>",html}var d,h,w="/build/images/",v={pointsOfInterest:[],social:[]},y={},P=[],k={},I=[],S={waypoints:null,social:null},z=!1;n()};