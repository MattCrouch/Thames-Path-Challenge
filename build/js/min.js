function fetchDonations(t){var e=$(".donate .current-amount .current"),n=$(".donate .current-amount .total");$.ajax({url:"fetchdonations.php",type:"GET",success:function(t){function o(){var t=parseFloat(e.data("amount")+u);t>e.data("total")&&(t=parseFloat(e.data("total"))),e.data("amount",t),e.text(t.toFixed(2)),t<e.data("total")&&setTimeout(function(){o()},r)}e.removeClass("loading"),n.removeClass("loading");var a=t.totalRaised.replace(/\,/g,""),i=t.target.replace(/\,/g,""),s=0;e.data("amount")&&(s=e.data("amount")),e.text(parseFloat(s).toFixed(2)).data("amount",parseFloat(s).toFixed(2)).data("total",parseFloat(a).toFixed(2)),n.text(i);var l=1e3,c=25,r=l/c,u=a/c;o()},error:function(){e.text("-"),n.text("-")}}),t&&setTimeout(function(){fetchDonations()},18e5)}function checkLive(t){$.ajax({url:"checklive.php",type:"GET",success:function(t){if(t.live){console.log("LIVE!");var e="<div class='live-banner'>Follow my progress right now! <a href='live' class='button'>Watch Live</a></div>";$("body").prepend(e)}else console.log("NOT LIVE :(")},error:function(){}}),t&&setTimeout(function(){checkLive()},18e5)}$(document).ready(function(){$("#map").length>0?map():(fetchDonations(),checkLive())});var map=function(){function t(){google.maps.event.addDomListener(window,"load",function(){P=new google.maps.Map($("#map")[0],{center:F.start,zoom:14,mapTypeControl:!1,streetViewControl:!1,zoomControlOptions:{position:google.maps.ControlPosition.TOP_LEFT}}),P.setOptions({styles:_}),n(),e(),o(),s(),m(),d(),h(),fetchDonations(D),$(".overlay a.show").click(function(t){t.preventDefault();var e=$(this),n=$(".overlay");n.hasClass("show")?(e.html("&#9650; Show Updates &#9650;"),n.removeClass("show")):(e.html("&#9660; Hide Updates &#9660;"),n.addClass("show"))})})}function e(){F={start:{name:"Putney Bridge",lat:51.46678,lng:-.213112,info:"START - Putney Bridge",icon:C.flag},"half way":{name:"Hurst Park",lat:51.392211,lng:-.344472,info:"25km - Half Way<br/>Hurst Park",icon:C.pointsOfInterest},finish:{name:"Runnymede Pleasure Ground",lat:51.442137,lng:-.55082,info:"FINISH - Runnymede",icon:C.flag}}}function n(){C.pointsOfInterest={anchor:new google.maps.Point(15,15),url:k+"live/icons/poi.svg",scaledSize:new google.maps.Size(30,30)},C.flag={anchor:new google.maps.Point(15,15),url:k+"live/icons/poi.svg",scaledSize:new google.maps.Size(30,30)},C.twitter={anchor:new google.maps.Point(15,15),url:k+"live/icons/twitter.svg",scaledSize:new google.maps.Size(30,30)},C.instagram={anchor:new google.maps.Point(15,15),url:k+"live/icons/instagram.svg",scaledSize:new google.maps.Size(30,30)},C.ping={anchor:new google.maps.Point(5,5),url:k+"live/icons/ping.svg",scaledSize:new google.maps.Size(10,10)}}function o(){a(x.pointsOfInterest),$.each(F,function(t,e){var n=c(e.lat,e.lng,e.name,e.icon);x.pointsOfInterest.push(n),v(x.pointsOfInterest);var o=new google.maps.InfoWindow({content:e.info});google.maps.event.addListener(n,"click",function(){i(),o.open(P,n),z.push(o)})})}function a(t){$.each(t,function(t,e){e.setMap(null)}),t=[]}function i(){$.each(z,function(t,e){e.close()})}function s(){b=new google.maps.Polyline({clickable:!1,strokeColor:"#0F3670",strokeOpacity:1,strokeWeight:5}),b.setMap(P),$.each(S,function(t,e){f(e)})}function l(t){var e={lat:t.lat,lng:t.lng,timestamp:t.timestamp,getPosition:function(){return new google.maps.LatLng(this.lat,this.lng)}};S.push(e),f(e)}function c(t,e,n,o){"undefined"==typeof o&&(o=null);var a=new google.maps.Marker({position:new google.maps.LatLng(t,e),title:n,icon:o,optimized:!1});return a.setMap(P),a}function r(t){var e=c(t.lat,t.lng,"this is a post from "+t.source,C[t.source]),n=new google.maps.InfoWindow({content:T(t)});google.maps.event.addListener(e,"click",function(){i(),n.open(P,e),z.push(n)})}function u(t){I.length>=O&&I.splice(I.length-1,1),I.unshift(t)}function g(t){var e=$(".overlay .lastfm .nowPlaying");e.addClass("out"),setTimeout(function(){e.remove()},1e3),p(t)}function p(t){var e=$(".overlay .lastfm"),n=L(t);e.append(n),setTimeout(function(){$(".overlay .lastfm .nowPlaying").removeClass("in")},1e3)}function f(t){var e=b.getPath(),n=new google.maps.LatLng(t.lat,t.lng);e.push(n)}function m(){$.ajax({url:"fetchcoords.php",data:{since:E.waypoints},type:"GET",success:function(t){E.waypoints=t.sinceTimestamp,$.each(t.coordinates,function(t,e){l(e)}),w(S),S.length>0&&y(S),D&&setTimeout(function(){m()},G.waypoints)},error:function(){console.log("Can't get the location at the moment :("),D&&setTimeout(function(){m()},G.waypoints)}})}function d(){$.ajax({url:"fetchsocial.php",data:{since:E.social},type:"GET",success:function(t){E.social=t.sinceTimestamp,$.each(t.posts,function(t,e){r(e)}),D&&setTimeout(function(){d()},G.social)},error:function(){console.log("Can't get social feeds :("),D&&setTimeout(function(){d()},G.social)}})}function h(){$.ajax({url:"fetchlastfm.php",data:{since:E.lastfm},type:"GET",success:function(t){E.lastfm=t.sinceTimestamp,$.each(t.tracks,function(t,e){u(e)}),t.tracks.length>0&&g(t.tracks[0]),D&&setTimeout(function(){d()},G.social)},error:function(){console.log("Can't get scrobbles :("),D&&setTimeout(function(){h()},G.scrobbles)}})}function v(t){for(var e=new google.maps.LatLngBounds,n=0;n<t.length;n++)e.extend(t[n].getPosition());P.fitBounds(e)}function y(t){var e=t.slice(0),n=100;e.length>n&&(e=e.splice(e.length-n)),v(e)}function w(t){var e=t[t.length-1];if(x.currentLocation)x.currentLocation.setPosition(e.getPosition());else{var n=c(e.lat,e.lng,"Current Location",C.ping);x.currentLocation=n}}function T(t){return html="<div class='social "+t.source+"'><a href='"+t.url+"' target='_blank'><img src='"+t.image+"'/></a><p class='caption'>"+t.text+"</p></div>",html}function L(t){return html="<div class='nowPlaying in'><a href='"+t.url+"'><img src='"+(""!==t.image_url_large?t.image_url_large:"build/images/live/icons/music-no-circle.svg")+"' alt='Now Playing' class='albumArt'/></a><div class='detail'><h3>Now Playing</h3><ul><li class='title'>"+t.title+"</li><li class='artist'>"+t.artist+"</li><li class='album'>"+t.album+"</li></ul></div></div>",html}var P,b,k="build/images/",x={pointsOfInterest:[],social:[],currentLocation:null},C={},z=[],F={},S=[],I=[],O=5,E={waypoints:null,social:null},D=!0,G={waypoints:6e4,social:3e5,scrobbles:3e5},_=[{featureType:"poi",stylers:[{visibility:"off"}]},{featureType:"transit",stylers:[{visibility:"off"}]},{featureType:"poi.park",stylers:[{visibility:"on"}]},{featureType:"poi.attraction",stylers:[{visibility:"on"}]}];t()};