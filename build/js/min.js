$(document).ready(function(){$("#map").length>0&&map()});var map=function(){function n(){google.maps.event.addDomListener(window,"load",function(){v=new google.maps.Map($("#map")[0],{center:S.start,zoom:14}),t(),e(),o(),s(),p(),m(),h()})}function e(){S={start:{name:"Putney Bridge",lat:51.46678,lng:-.213112,info:"START - Putney Bridge",icon:T.flag},"half way":{name:"Hurst Park",lat:51.392211,lng:-.344472,info:"25km - Half Way<br/>Hurst Park",icon:T.pointsOfInterest},finish:{name:"Runnymede Pleasure Ground",lat:51.442137,lng:-.55082,info:"FINISH - Runnymede",icon:T.flag}}}function t(){T.pointsOfInterest={anchor:new google.maps.Point(15,15),url:k+"live/icons/poi.svg",scaledSize:new google.maps.Size(30,30)},T.flag={anchor:new google.maps.Point(15,15),url:k+"live/icons/poi.svg",scaledSize:new google.maps.Size(30,30)},T.twitter={anchor:new google.maps.Point(15,15),url:k+"live/icons/twitter.svg",scaledSize:new google.maps.Size(30,30)},T.instagram={anchor:new google.maps.Point(15,15),url:k+"live/icons/instagram.svg",scaledSize:new google.maps.Size(30,30)}}function o(){a(P.pointsOfInterest),$.each(S,function(n,e){var t=l(e.lat,e.lng,e.name,e.icon);P.pointsOfInterest.push(t),d(P.pointsOfInterest);var o=new google.maps.InfoWindow({content:e.info});google.maps.event.addListener(t,"click",function(){i(),o.open(v,t),I.push(o)})})}function a(n){$.each(n,function(n,e){e.setMap(null)}),n=[]}function i(){$.each(I,function(n,e){e.close()})}function s(){y=new google.maps.Polyline({clickable:!1,strokeColor:"#0F3670",strokeOpacity:1,strokeWeight:5}),y.setMap(v),$.each(z,function(n,e){f(e)})}function c(n){var e={lat:n.lat,lng:n.lng,timestamp:n.timestamp};z.push(e),f(e)}function l(n,e,t,o){"undefined"==typeof o&&(o=null);var a=new google.maps.Marker({position:new google.maps.LatLng(n,e),title:t,icon:o});return a.setMap(v),a}function r(n){var e=l(n.lat,n.lng,"this is a post from "+n.source,T[n.source]),t=new google.maps.InfoWindow({content:w(n)});google.maps.event.addListener(e,"click",function(){i(),t.open(v,e),I.push(t)})}function u(n){L.length>=b&&L.splice(L.length-1,1),L.unshift(n),console.log(L[0].title),g(n)}function g(n){var e=$("#some-template").html(),t=Handlebars.compile(e);$(".overlay .lastfm").html(t(n))}function f(n){var e=y.getPath(),t=new google.maps.LatLng(n.lat,n.lng);e.push(t)}function p(){$.ajax({url:"fetchcoords.php",data:{since:O.waypoints},type:"GET",success:function(n){O.waypoints=n.sinceTimestamp,$.each(n.coordinates,function(n,e){c(e)}),x&&setTimeout(function(){p()},6e4)},error:function(){alert("Can't get the location at the moment :(")}})}function m(){$.ajax({url:"fetchsocial.php",data:{since:O.social},type:"GET",success:function(n){O.social=n.sinceTimestamp,$.each(n.posts,function(n,e){r(e)}),x&&setTimeout(function(){m()},3e5)},error:function(){alert("Can't get social feeds :(")}})}function h(){$.ajax({url:"fetchlastfm.php",data:{since:O.lastfm},type:"GET",success:function(n){O.lastfm=n.sinceTimestamp,$.each(n.tracks,function(n,e){u(e)}),x&&setTimeout(function(){h()},3e5)},error:function(){alert("Can't get scrobbles :(")}})}function d(n){for(var e=new google.maps.LatLngBounds,t=0;t<n.length;t++)e.extend(n[t].getPosition());v.fitBounds(e)}function w(n){return html="<div class='social "+n.source+"'><a href='"+n.url+"' target='_blank'><img src='"+n.image+"'/></a><p class='caption'>"+n.text+"</p></div>",html}var v,y,k="/build/images/",P={pointsOfInterest:[],social:[]},T={},I=[],S={},z=[],L=[],b=5,O={waypoints:null,social:null},x=!1;n()};