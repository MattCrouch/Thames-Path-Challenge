$(document).ready(function(){$("#map").length>0&&map()});var map=function(){function n(){google.maps.event.addDomListener(window,"load",function(){r=new google.maps.Map($("#map")[0],{center:m.start,zoom:14}),t(),a(),c()})}function t(){e(f.pointsOfInterest),$.each(m,function(n,t){var e=new google.maps.Marker({position:new google.maps.LatLng(t.lat,t.lng),title:t.name});e.setMap(r),f.pointsOfInterest.push(e),l(f.pointsOfInterest);var a=new google.maps.InfoWindow({content:t.info});google.maps.event.addListener(e,"click",function(){o(),a.open(r,e),p.push(a)})})}function e(n){$.each(n,function(n,t){t.setMap(null)}),n=[]}function o(){$.each(p,function(n,t){t.close()})}function a(){u=new google.maps.Polyline({strokeColor:"#000000",strokeOpacity:1,strokeWeight:3}),u.setMap(r),$.each(d,function(n,t){s(t)})}function i(n){console.log(n);var t={lat:n.lat,lng:n.lng,timestamp:n.timestamp};d.push(t),s(t)}function s(n){var t=u.getPath(),e=new google.maps.LatLng(n.lat,n.lng);t.push(e)}function c(){$.ajax({url:"fetchcoords.php",data:{since:g},type:"GET",success:function(n){g=n.sinceTimestamp,$.each(n.coordinates,function(n,t){i(t)}),h&&setTimeout(function(){c()},6e4)},error:function(){alert("Can't get the location at the moment :(")}})}function l(n){for(var t=new google.maps.LatLngBounds,e=0;e<n.length;e++)t.extend(n[e].getPosition());r.fitBounds(t)}var r,u,g,f={pointsOfInterest:[]},p=[],m={start:{name:"Putney Bridge",lat:51.46678,lng:-.213112,info:"START - Putney Bridge"},"half way":{name:"Hurst Park",lat:51.392211,lng:-.344472,info:"25km - Half Way<br/>Hurst Park"},finish:{name:"Runnymede Pleasure Ground",lat:51.442137,lng:-.55082,info:"FINISH - Runnymede"}},d=[],h=!1;n()};