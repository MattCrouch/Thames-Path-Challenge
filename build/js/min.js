$(document).ready(function(){$("#map").length>0&&map()});var map=function(){function n(){google.maps.event.addDomListener(window,"load",function(){g=new google.maps.Map($("#map")[0],{center:w.start,zoom:14}),t(),a(),u(),r()})}function t(){e(d.pointsOfInterest),$.each(w,function(n,t){var e=s(t.lat,t.lng,t.name);d.pointsOfInterest.push(e),f(d.pointsOfInterest);var a=new google.maps.InfoWindow({content:t.info});google.maps.event.addListener(e,"click",function(){o(),a.open(g,e),h.push(a)})})}function e(n){$.each(n,function(n,t){t.setMap(null)}),n=[]}function o(){$.each(h,function(n,t){t.close()})}function a(){m=new google.maps.Polyline({strokeColor:"#000000",strokeOpacity:1,strokeWeight:3}),m.setMap(g),$.each(v,function(n,t){l(t)})}function i(n){console.log(n);var t={lat:n.lat,lng:n.lng,timestamp:n.timestamp};v.push(t),l(t)}function s(n,t,e){var o=new google.maps.Marker({position:new google.maps.LatLng(n,t),title:e});return o.setMap(g),o}function c(n){console.log(n);var t=s(n.lat,n.lng,"this is a post from "+n.source),e=new google.maps.InfoWindow({content:p(n)});google.maps.event.addListener(t,"click",function(){o(),e.open(g,t),h.push(e)})}function l(n){var t=m.getPath(),e=new google.maps.LatLng(n.lat,n.lng);t.push(e)}function u(){$.ajax({url:"fetchcoords.php",data:{since:y.waypoints},type:"GET",success:function(n){y.waypoints=n.sinceTimestamp,$.each(n.coordinates,function(n,t){i(t)}),k&&setTimeout(function(){u()},6e4)},error:function(){alert("Can't get the location at the moment :(")}})}function r(){$.ajax({url:"fetchsocial.php",data:{since:y.social},type:"GET",success:function(n){y.social=n.sinceTimestamp,$.each(n.posts,function(n,t){c(t)}),k&&setTimeout(function(){r()},3e5)},error:function(){alert("Can't get social feeds :(")}})}function f(n){for(var t=new google.maps.LatLngBounds,e=0;e<n.length;e++)t.extend(n[e].getPosition());g.fitBounds(t)}function p(n){return html="<div class='social "+n.source+"'><a href='"+n.url+"' target='_blank'><img src='"+n.image+"'/></a><p class='caption'>"+n.text+"</p></div>",html}var g,m,d={pointsOfInterest:[],social:[]},h=[],w={start:{name:"Putney Bridge",lat:51.46678,lng:-.213112,info:"START - Putney Bridge"},"half way":{name:"Hurst Park",lat:51.392211,lng:-.344472,info:"25km - Half Way<br/>Hurst Park"},finish:{name:"Runnymede Pleasure Ground",lat:51.442137,lng:-.55082,info:"FINISH - Runnymede"}},v=[],y={waypoints:null,social:null},k=!1;n()};