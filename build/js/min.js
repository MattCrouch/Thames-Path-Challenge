$(document).ready(function(){$("#map").length>0&&map()});var map=function(){function n(){google.maps.event.addDomListener(window,"load",function(){P=new google.maps.Map($("#map")[0],{center:z.start,zoom:14}),t(),e(),o(),s(),p(),d(),h(),$(document).on("click","#map",function(n){console.log("DO THIS"),g(O[0])})})}function e(){z={start:{name:"Putney Bridge",lat:51.46678,lng:-.213112,info:"START - Putney Bridge",icon:S.flag},"half way":{name:"Hurst Park",lat:51.392211,lng:-.344472,info:"25km - Half Way<br/>Hurst Park",icon:S.pointsOfInterest},finish:{name:"Runnymede Pleasure Ground",lat:51.442137,lng:-.55082,info:"FINISH - Runnymede",icon:S.flag}}}function t(){S.pointsOfInterest={anchor:new google.maps.Point(15,15),url:T+"live/icons/poi.svg",scaledSize:new google.maps.Size(30,30)},S.flag={anchor:new google.maps.Point(15,15),url:T+"live/icons/poi.svg",scaledSize:new google.maps.Size(30,30)},S.twitter={anchor:new google.maps.Point(15,15),url:T+"live/icons/twitter.svg",scaledSize:new google.maps.Size(30,30)},S.instagram={anchor:new google.maps.Point(15,15),url:T+"live/icons/instagram.svg",scaledSize:new google.maps.Size(30,30)}}function o(){a(I.pointsOfInterest),$.each(z,function(n,e){var t=c(e.lat,e.lng,e.name,e.icon);I.pointsOfInterest.push(t),v(I.pointsOfInterest);var o=new google.maps.InfoWindow({content:e.info});google.maps.event.addListener(t,"click",function(){i(),o.open(P,t),b.push(o)})})}function a(n){$.each(n,function(n,e){e.setMap(null)}),n=[]}function i(){$.each(b,function(n,e){e.close()})}function s(){k=new google.maps.Polyline({clickable:!1,strokeColor:"#0F3670",strokeOpacity:1,strokeWeight:5}),k.setMap(P),$.each(L,function(n,e){m(e)})}function l(n){var e={lat:n.lat,lng:n.lng,timestamp:n.timestamp};L.push(e),m(e)}function c(n,e,t,o){"undefined"==typeof o&&(o=null);var a=new google.maps.Marker({position:new google.maps.LatLng(n,e),title:t,icon:o});return a.setMap(P),a}function r(n){var e=c(n.lat,n.lng,"this is a post from "+n.source,S[n.source]),t=new google.maps.InfoWindow({content:w(n)});google.maps.event.addListener(e,"click",function(){i(),t.open(P,e),b.push(t)})}function u(n){O.length>=C&&O.splice(O.length-1,1),O.unshift(n),console.log(O[0].title),g(n)}function g(n){$(".overlay .lastfm .nowPlaying").addClass("out"),setTimeout(function(){f(n)},1e3)}function f(n){console.log("create track view!");var e=$(".overlay .lastfm"),t=y(n);e.html(t),setTimeout(function(){$(".overlay .lastfm .nowPlaying").removeClass("in")},1e3)}function m(n){var e=k.getPath(),t=new google.maps.LatLng(n.lat,n.lng);e.push(t)}function p(){$.ajax({url:"fetchcoords.php",data:{since:x.waypoints},type:"GET",success:function(n){x.waypoints=n.sinceTimestamp,$.each(n.coordinates,function(n,e){l(e)}),H&&setTimeout(function(){p()},6e4)},error:function(){alert("Can't get the location at the moment :(")}})}function d(){$.ajax({url:"fetchsocial.php",data:{since:x.social},type:"GET",success:function(n){x.social=n.sinceTimestamp,$.each(n.posts,function(n,e){r(e)}),H&&setTimeout(function(){d()},3e5)},error:function(){alert("Can't get social feeds :(")}})}function h(){$.ajax({url:"fetchlastfm.php",data:{since:x.lastfm},type:"GET",success:function(n){x.lastfm=n.sinceTimestamp,$.each(n.tracks,function(n,e){u(e)}),H&&setTimeout(function(){h()},3e5)},error:function(){alert("Can't get scrobbles :(")}})}function v(n){for(var e=new google.maps.LatLngBounds,t=0;t<n.length;t++)e.extend(n[t].getPosition());P.fitBounds(e)}function w(n){return html="<div class='social "+n.source+"'><a href='"+n.url+"' target='_blank'><img src='"+n.image+"'/></a><p class='caption'>"+n.text+"</p></div>",html}function y(n){return html="<div class='nowPlaying in'><a href='"+n.url+"'><img src='"+(""!==n.image_url_large?n.image_url_large:"build/images/live/icons/music-no-circle.svg")+"' alt='Now Playing' class='albumArt'/></a><div class='detail'><span>Now Playing</span><ul><li class='title'>"+n.title+"</li><li class='artist'>"+n.artist+"</li><li class='album'>"+n.album+"</li></ul></div></div>",html}var P,k,T="/build/images/",I={pointsOfInterest:[],social:[]},S={},b=[],z={},L=[],O=[],C=5,x={waypoints:null,social:null},H=!1;n()};