$(document).ready(function(){$("#map").length>0&&map()});var map=function(){function n(){google.maps.event.addDomListener(window,"load",function(){k=new google.maps.Map($("#map")[0],{center:I.start,zoom:14,mapTypeControl:!1,streetViewControl:!1,zoomControlOptions:{position:google.maps.ControlPosition.TOP_LEFT}}),k.setOptions({styles:H}),t(),e(),o(),s(),m(),h(),d(),$(".overlay a.show").click(function(n){n.preventDefault();var e=$(this),t=$(".overlay");t.hasClass("show")?(e.html("&#9650; Show Updates &#9650;"),t.removeClass("show")):(e.html("&#9660; Hide Updates &#9660;"),t.addClass("show"))})})}function e(){I={start:{name:"Putney Bridge",lat:51.46678,lng:-.213112,info:"START - Putney Bridge",icon:z.flag},"half way":{name:"Hurst Park",lat:51.392211,lng:-.344472,info:"25km - Half Way<br/>Hurst Park",icon:z.pointsOfInterest},finish:{name:"Runnymede Pleasure Ground",lat:51.442137,lng:-.55082,info:"FINISH - Runnymede",icon:z.flag}}}function t(){z.pointsOfInterest={anchor:new google.maps.Point(15,15),url:C+"live/icons/poi.svg",scaledSize:new google.maps.Size(30,30)},z.flag={anchor:new google.maps.Point(15,15),url:C+"live/icons/poi.svg",scaledSize:new google.maps.Size(30,30)},z.twitter={anchor:new google.maps.Point(15,15),url:C+"live/icons/twitter.svg",scaledSize:new google.maps.Size(30,30)},z.instagram={anchor:new google.maps.Point(15,15),url:C+"live/icons/instagram.svg",scaledSize:new google.maps.Size(30,30)},z.ping={anchor:new google.maps.Point(5,5),url:C+"live/icons/ping-head.svg",scaledSize:new google.maps.Size(10,10)}}function o(){i(T.pointsOfInterest),$.each(I,function(n,e){var t=c(e.lat,e.lng,e.name,e.icon);T.pointsOfInterest.push(t),v(T.pointsOfInterest);var o=new google.maps.InfoWindow({content:e.info});google.maps.event.addListener(t,"click",function(){a(),o.open(k,t),S.push(o)})})}function i(n){$.each(n,function(n,e){e.setMap(null)}),n=[]}function a(){$.each(S,function(n,e){e.close()})}function s(){b=new google.maps.Polyline({clickable:!1,strokeColor:"#0F3670",strokeOpacity:1,strokeWeight:5}),b.setMap(k),$.each(O,function(n,e){p(e)})}function l(n){var e={lat:n.lat,lng:n.lng,timestamp:n.timestamp,getPosition:function(){return new google.maps.LatLng(this.lat,this.lng)}};O.push(e),p(e)}function c(n,e,t,o){"undefined"==typeof o&&(o=null);var i=new google.maps.Marker({position:new google.maps.LatLng(n,e),title:t,icon:o,optimized:!1});return i.setMap(k),i}function r(n){var e=c(n.lat,n.lng,n.source,z[n.source]),t=new google.maps.InfoWindow({content:P(n)});google.maps.event.addListener(e,"click",function(){a(),t.open(k,e),S.push(t)})}function g(n){_.length>=x&&_.splice(_.length-1,1),_.unshift(n)}function u(n){var e=$(".overlay .lastfm .nowPlaying");e.addClass("out"),setTimeout(function(){e.remove()},1e3),f(n)}function f(n){var e=$(".overlay .lastfm"),t=L(n);e.append(t),setTimeout(function(){$(".overlay .lastfm .nowPlaying").removeClass("in")},1e3)}function p(n){var e=b.getPath(),t=new google.maps.LatLng(n.lat,n.lng);e.push(t)}function m(){$.ajax({url:"fetchcoords.php",type:"GET",success:function(n){$.each(n.coordinates,function(n,e){l(e)}),y(O),n.coordinates.length>0&&O.length>0&&w(O)},error:function(){console.log("Can't get the location at the moment :(")}})}function h(){$.ajax({url:"fetchsocial.php",type:"GET",success:function(n){$.each(n.posts,function(n,e){r(e)})},error:function(){console.log("Can't get social feeds :(")}})}function d(){$.ajax({url:"fetchlastfm.php",type:"GET",success:function(n){$.each(n.tracks,function(n,e){g(e)}),n.tracks.length>0&&u(n.tracks[0])},error:function(){console.log("Can't get scrobbles :(")}})}function v(n){for(var e=new google.maps.LatLngBounds,t=0;t<n.length;t++)e.extend(n[t].getPosition());k.fitBounds(e)}function w(n){var e=n.slice(0),t=100;e.length>t&&(e=e.splice(e.length-t)),v(e)}function y(n){var e=n[n.length-1];if(!e)return!1;if(T.currentLocation)T.currentLocation.setPosition(e.getPosition());else{var t=c(e.lat,e.lng,"Current Location",z.ping);T.currentLocation=t}}function P(n){return html="<div class='social "+n.source+"'>",""!==n.image&&(html+="<a href='"+n.url+"' target='_blank'><img src='"+n.image+"'/></a>"),html+="<p class='caption'>"+n.text+"</p></div>",html}function L(n){return html="<div class='nowPlaying in'><a href='"+n.url+"'><img src='"+(""!==n.image_url_large?n.image_url_large:"build/images/live/icons/music-no-circle.svg")+"' alt='Now Playing' class='albumArt'/></a><div class='detail'><h3>Now Playing</h3><ul><li class='title'>"+n.title+"</li><li class='artist'>"+n.artist+"</li><li class='album'>"+n.album+"</li></ul></div></div>",html}var k,b,C="build/images/",T={pointsOfInterest:[],social:[],currentLocation:null},z={},S=[],I={},O=[],_=[],x=5,H=[{featureType:"poi",stylers:[{visibility:"off"}]},{featureType:"transit",stylers:[{visibility:"off"}]},{featureType:"poi.park",stylers:[{visibility:"on"}]},{featureType:"poi.attraction",stylers:[{visibility:"on"}]}];n()};